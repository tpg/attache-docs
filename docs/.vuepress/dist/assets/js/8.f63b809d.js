(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{325:function(t,s,e){"use strict";e.r(s);var a=e(33),r=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"script-hooks"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#script-hooks"}},[t._v("#")]),t._v(" Script Hooks")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img.shields.io/github/v/release/tpg/attache?style=flat-square",alt:""}})]),t._v(" "),e("p",[t._v("Attaché's deployment process is fairly rigid and doesn't really allow for much customization. This is by design and follows a deployment method that has been tried and well tested. However, in some cases, you may need to add steps to the different deployment tasks. That's where "),e("strong",[t._v("script hooks")]),t._v(" come in. There's nothing all that complex about script hooks, but they do allow for a small amount of flexibility around your deployments.")]),t._v(" "),e("p",[t._v("There are a few script hooks available and they let you insert commands before or after any number of steps during deployment. There are four tasks that are run for each deployment, namely "),e("strong",[t._v("build")]),t._v(", "),e("strong",[t._v("deploy")]),t._v(", "),e("strong",[t._v("assets")]),t._v(" and "),e("strong",[t._v("live")]),t._v(". The big one is the "),e("strong",[t._v("deploy")]),t._v(" task, which contains a number of steps. The others represent smaller, but no-less important task. You can hook into any one of these tasks, either before or after, by passing an array of commands to hooks specified in a "),e("code",[t._v("scripts")]),t._v(" object per server.")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("div",{staticClass:"highlight-lines"},[e("br"),e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("br")]),e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"servers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"production"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"before-deploy"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"echo \\"Deploying\\""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"task-hooks"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#task-hooks"}},[t._v("#")]),t._v(" Task hooks")]),t._v(" "),e("p",[t._v("Each task has a "),e("code",[t._v("before")]),t._v(" and "),e("code",[t._v("after")]),t._v(" script hook. So there is a "),e("code",[t._v("before-build")]),t._v(", an "),e("code",[t._v("after-build")]),t._v(", a "),e("code",[t._v("before-deply")]),t._v(" and an "),e("code",[t._v("after-deploy")]),t._v(". The same for "),e("code",[t._v("assets")]),t._v(" and "),e("code",[t._v("live")]),t._v(".")]),t._v(" "),e("p",[t._v("For example, if you're using the "),e("code",[t._v("migrate")]),t._v(" setting and allowing Attaché to migrate changes to your database, you might consider dumping your database just before deployment.")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("div",{staticClass:"highlight-lines"},[e("br"),e("br"),e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("br"),e("br"),e("br"),e("br")]),e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"servers"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"production"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"before-deploy"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n                    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mysqldump --databases my_app storage/backups/backup.sql"')]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"deploy-step-hooks"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deploy-step-hooks"}},[t._v("#")]),t._v(" Deploy step hooks")]),t._v(" "),e("p",[t._v("In addition to the hooks around the for major tasks, you can also hook into the steps within the tasks. The following steps also have before and after script hooks:")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Step")]),t._v(" "),e("th",[t._v("Description")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("code",[t._v("clone")])]),t._v(" "),e("td",[t._v("Run scripts before or after the project is cloned from the Git repo.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("prep-composer")])]),t._v(" "),e("td",[t._v("Run scripts before or after Composer is downloaded or updated.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("composer")])]),t._v(" "),e("td",[t._v("Run scripts before or after the "),e("code",[t._v("composer install")]),t._v(" command is run.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("install")])]),t._v(" "),e("td",[t._v("Run scripts before or after the "),e("code",[t._v(".env")]),t._v(" file and "),e("code",[t._v("storage")]),t._v(" directory are created during install.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("symlinks")])]),t._v(" "),e("td",[t._v("Run scripts before or after the "),e("code",[t._v(".env")]),t._v(" and "),e("code",[t._v("storage")]),t._v(" symbolic links are created.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("migrate")])]),t._v(" "),e("td",[t._v("Run scripts before or after the database is migrated.")])])])]),t._v(" "),e("p",[t._v("Some scripts are dependent on configuration or current process. The "),e("code",[t._v("install")]),t._v(" scripts will only run during installation when running the "),e("code",[t._v("attache install")]),t._v(" command, and the "),e("code",[t._v("migrate")]),t._v(" scripts will only run if the "),e("code",[t._v("migrate")]),t._v(" setting has been set to "),e("code",[t._v("true")]),t._v(" in the configuration.")]),t._v(" "),e("p",[t._v("The previous example could then be updated by changing the "),e("code",[t._v("before-deploy")]),t._v(" hook to a "),e("code",[t._v("before-migrate")]),t._v(" hook ensuring that it only runs when migrations are done.")]),t._v(" "),e("p",[t._v("You can add as many commands per script hook as you like. Since they are arrays you can simply comma-separate script lines.")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("div",{staticClass:"highlight-lines"},[e("br"),e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("br"),e("br")]),e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//...")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"after-composer"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"echo \\"Dependencies installed.\\""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@php @release/artisan custom-command"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"script-tags"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#script-tags"}},[t._v("#")]),t._v(" Script tags")]),t._v(" "),e("p",[t._v("All scripts are run from the servers root path. This means that if you need to access files from your scripts that belong to the current release, you'll need to know the release ID. Since you won't actually have that information, Attaché provides a script tag that will insert the correct path to the release into your script. There are a few other tags as well which can be handy.")]),t._v(" "),e("p",[t._v("All tags are prefixed with a single "),e("code",[t._v("@")]),t._v(". If needed, you can also surround your tags using double-braces:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"after-composer"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"releases/{{ @release }}/artisan some-command"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h3",{attrs:{id:"available-tags"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#available-tags"}},[t._v("#")]),t._v(" Available tags")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Tag")]),t._v(" "),e("th",[t._v("Description")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("code",[t._v("@php")])]),t._v(" "),e("td",[t._v("The configured PHP binary.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("@composer")])]),t._v(" "),e("td",[t._v("The configured Composer binary.")])]),t._v(" "),e("tr",[e("td",[e("code",[t._v("@release")])]),t._v(" "),e("td",[t._v("The ID of the current release.")])])])]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),e("p",[t._v("Do not attempt to use the "),e("code",[t._v("@release")]),t._v(" tag in a "),e("code",[t._v("before-build")]),t._v(", "),e("code",[t._v("after-build")]),t._v(", "),e("code",[t._v("before-deploy")]),t._v(" or "),e("code",[t._v("before-clone")]),t._v(" script hook as the ID will be that of the currently ACTIVE release. This is a result of the new release not actually existing on the server yet.")])])])}),[],!1,null,null,null);s.default=r.exports}}]);